---
import Layout from '../layouts/Layout.astro'
import currentWork from '../data/current-work.json'
import previous from '../data/previous.json'
import art from '../data/art.json'
import talks from '../data/talks.json'
import projectsList from '../data/projects-list.json'
import tinyTiger from '../data/tiny-tiger.json'
import openSource from '../data/open-source.json'
import hacks from '../data/hacks.json'
import security from '../data/security.json'

const renderList = (items: any[], prefix = '', options: any = {}) => {
  return items
    .map((item, i) => {
      const symbol = i === items.length - 1 ? '╰' : '├'
      let link
      if (options.addPlayButton) {
        link = `<a href="#" class="track-link" data-track-index="${i}">${item.name} <span class="track-play">▶</span></a>`
      } else if (options.addVideoButton && item.videoId) {
        const aspectRatio = item.aspectRatio || '16 / 9'
        const videoContainer = `<div class="inline-video" data-video-index="${i}" style="display: none;"><iframe class="youtube-iframe" style="aspect-ratio: ${aspectRatio};" src="https://www.youtube.com/embed/${item.videoId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>`
        link = `<a href="#" class="video-link" data-video-index="${i}">${item.name} <span class="video-toggle">▶</span></a>${videoContainer}`
      } else {
        link = item.url
          ? `<a href="${item.url}" target="_blank">${item.name}</a>`
          : item.name
      }
      const desc = item.description ? ` - ${item.description}` : ''
      return `${prefix}${symbol} ${link}${desc}`
    })
    .join('\n')
}

const introContent = `hi, my name is piérre reimertz.
i'm a developer, designer and occasional musician.

co-founder / cto at <a href="https://hifilabs.co" target="_blank">hifi labs</a>

╭ current work
${renderList(currentWork)}

prev ╮
${renderList(previous, '     ')}

art ╮
${renderList(art, '    ')}

talks ╮
${renderList(talks, '      ', { addVideoButton: true })}

projects ╮
${renderList(projectsList, '         ')}

╭ tiny tiger
${renderList(tinyTiger, '', { addPlayButton: true }).replace(/target="_blank"/g, '')}

╭ open-source
${renderList(openSource)}

hacks ╮
${renderList(hacks, '      ')}

security ╮
${renderList(security, '         ')}


<a href="http://github.com/reimertz" target="_blank">github</a> | <a href="http://x.com/reimertz" target="_blank">x</a> | <a href="https://www.linkedin.com/in/reimertz" target="_blank">linkedin</a> | <a href="mailto:pierre.reimertz@gmail.com">contact me</a>`
---

<Layout title="reimertz.co">
  <all-my-secret-api-keys></all-my-secret-api-keys>
  <main class="tre-d">
    <header>
      <img-3d class="me"></img-3d>
      <p-3d
        three-d-text={introContent.replace(/<[^>]*>/g, '')}
        set:html={introContent}
      />
    </header>
  </main>

  <script is:inline define:vars={{ tinyTigerData: tinyTiger }}>
    window.tinyTigerData = tinyTigerData
  </script>

  <script>
    import GlobalMusicPlayer from '../scripts/GlobalMusicPlayer'

    declare global {
      interface Window {
        tinyTigerData: any
      }
    }

    const player = new GlobalMusicPlayer(window.tinyTigerData)
    player.start()

    // Music player for tiny tiger tracks
    const trackLinks = document.querySelectorAll('.track-link')

    trackLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault()
        const trackIndexAttr = link.getAttribute('data-track-index')
        if (!trackIndexAttr) return
        const trackIndex = parseInt(trackIndexAttr)
        const playIcon = link.querySelector('.track-play')
        if (!playIcon) return

        if (player.isPlaying && player.currentTrack === trackIndex) {
          // Pause current track
          player.pause()
          playIcon.textContent = '▶'
        } else {
          // Stop previous track
          if (player.isPlaying) {
            const prevLink = document.querySelector(
              `.track-link[data-track-index="${player.currentTrack}"]`
            )
            if (prevLink) {
              const prevPlayIcon = prevLink.querySelector('.track-play')
              if (prevPlayIcon) {
                prevPlayIcon.textContent = '▶'
              }
            }
          }

          // Play new track
          player.currentTrack = trackIndex
          player.loadTrack(trackIndex)
          player.play()
          playIcon.textContent = '⏸'
        }
      })
    })

    // YouTube inline video for talks
    const videoLinks = document.querySelectorAll('.video-link')

    videoLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault()
        const videoIndex = link.getAttribute('data-video-index')
        if (!videoIndex) return
        const toggle = link.querySelector('.video-toggle')
        if (!toggle) return
        const videoContainer = document.querySelector(
          `.inline-video[data-video-index="${videoIndex}"]`
        ) as HTMLElement | null
        if (!videoContainer) return

        // Pause music if playing
        if (player.isPlaying) {
          player.pause()
          const playingLink = document.querySelector(
            `.track-link[data-track-index="${player.currentTrack}"]`
          )
          if (playingLink) {
            const playingPlayIcon = playingLink.querySelector('.track-play')
            if (playingPlayIcon) {
              playingPlayIcon.textContent = '▶'
            }
          }
        }

        // Toggle video
        if (
          videoContainer.style.display === 'none' ||
          !videoContainer.style.display
        ) {
          // Close other videos first
          document.querySelectorAll('.inline-video').forEach((v) => {
            if (v !== videoContainer) {
              const vElement = v as HTMLElement
              vElement.style.display = 'none'
              const oldIframe = v.querySelector('iframe') as HTMLIFrameElement | null
              if (oldIframe) {
                const oldSrc = oldIframe.src
                oldIframe.src = ''
                oldIframe.src = oldSrc.replace('?autoplay=1', '?autoplay=0')
              }
            }
          })
          document.querySelectorAll('.video-toggle').forEach((t) => {
            if (t !== toggle) t.textContent = '▶'
          })

          // Open this video
          videoContainer.style.display = 'block'
          toggle.textContent = '×'
          const iframe = videoContainer.querySelector('iframe') as HTMLIFrameElement | null
          if (iframe) {
            const originalSrc = iframe.getAttribute('src')
            if (originalSrc) {
              iframe.src = originalSrc.replace('?autoplay=0', '?autoplay=1')
            }
          }
          videoContainer.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
          })
        } else {
          // Close this video and stop playback
          const iframe = videoContainer.querySelector('iframe') as HTMLIFrameElement | null
          if (iframe) {
            iframe.src = ''
          }
          videoContainer.style.display = 'none'
          toggle.textContent = '▶'
        }
      })
    })
  </script>
</Layout>
